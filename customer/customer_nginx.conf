server {
    listen       80;
    server_name  localhost 140.128.101.122;

    # 提供根目錄中的所有靜態文件（不受保護）
    location / {
        root /usr/share/nginx/html/customer;
        index private.html;

        # 不對根目錄中的文件應用 auth_request
        auth_request off;
        try_files $uri $uri/ =404;
    }

    # 保護 customer_private.html
    location = /private.html {
        auth_request /api/customer/auth;
        auth_request_set $auth_status $upstream_status;

        # 如果未授權，重定向到登入頁
        if ($auth_status = 401) {
            return 302 /customer_login.html?redirect=$request_uri;
        }

        # 如果已授權，提供文件
        root /usr/share/nginx/html/customer;
        index customer_private.html;
    }

    # 認證檢查
    location = /api/customer/auth {
        proxy_pass http://140.128.101.122:31167/api/customer/auth;
        proxy_set_header Content-Type application/json;

        # 傳遞客戶端請求中的必要數據
        proxy_set_header Authorization $http_authorization;
        proxy_set_header Cookie $http_cookie;

        # 成功認證時自動跳轉到 /customer_private.html
        proxy_intercept_errors on;
        error_page 200 = /customer_private.html;
    }

    # 認證失敗處理
    location @error401 {
        return 302 http://140.128.101.122:32431/customer_login.html?redirect=$request_uri;
    }

    # 通用錯誤頁面
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }

    # 禁止訪問 .ht 文件
    location ~ /\.ht {
        deny  all;
    }
}